# vim: syntax=bash

@define JAVA_HOME "$HOME/.sdkman/candidates/java/23.ea.3-open"
@define JAVA_BIN  "$JAVA_HOME/bin"
@define JAVA      "$JAVA_BIN/java"
@define JAVAC     "$JAVA_BIN/javac"

@goal gen
@doc 'Generate implementations by templates'
  awk -f gen.awk

@goal test
  mvn test

@goal test1
  mvn test -Dtest='gc_less.no_unsafe.tpl.TemplateArrayTests'
@goal test2
  mvn test -Dtest='gc_less.no_unsafe.tpl.TemplateHashtableTests'

@goal java_version
  $JAVA -version

@goal compiled @private
@depends_on gen
@depends_on java_version
#  mvn compile
  $JAVAC src/main/java/gc_less/*.java src/main/java/gc_less/*/*.java -d target/classes

@goal main4
@doc 'Runs java with No-op GC (EpsilonGC)'
@depends_on compiled
  $JAVA \
    -Xlog:gc \
    -XX:+UnlockExperimentalVMOptions -XX:+UseEpsilonGC \
    -Xms2m -Xmx2m \
    -cp target/classes gc_less.Main4

@goal vs
@doc 'Compares mem consumption of Unsafe-based hashtable vs MemorySegment-based'
@depends_on compiled
  $JAVA \
    -Xlog:gc \
    -XX:+UnlockExperimentalVMOptions -XX:+UseEpsilonGC \
    -Xms8m -Xmx8m \
    -cp target/classes gc_less.MainHashtableComparison

@goal run @params CLASS
@depends_on compiled
  $JAVA -cp target/classes "$CLASS"

@goal speedtest
@doc 'IntHashtable speed test'
@depends_on run @args 'gc_less.IntHashtableSpeedTest'

@goal speedtest1
@depends_on run @args 'gc_less.no_unsafe.AccessSpeedTest'

@goal new1
  mvn compile exec:java -Dexec.mainClass="gc_less.no_unsafe.Main1"

@goal new2
  mvn compile exec:java -Dexec.mainClass="gc_less.no_unsafe.Main2"

@goal new3
  mvn compile exec:java -Dexec.mainClass="gc_less.no_unsafe.Main3"

@goal crash
  mvn compile exec:java -Dexec.mainClass="gc_less.Crash"
